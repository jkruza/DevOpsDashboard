@{
    ViewBag.Title = "DevOps Dashboard";
}



<div class="row" id="lists" style="padding-top: 50px;">
    <div class="col-md-8"><div id="list"></div></div>
    <div class="col-md-4"><div id="blist"></div></div>
</div>



@section scripts {

    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var dashboard = $.connection.dashboardMessageHub;
            // Create a function that the hub can call back to display messages.
            dashboard.client.broadcastDashboardMessage = processMessage;
            dashboard.client.pushFromCache = processCache;

            $.connection.hub.start().done(function () {

            });
        });

        function processCache(cjsonString) {

            if (typeof cjsonString == "string")
            { var cjson = JSON.parse(cjsonString); }
            else {
                var cjson = cjsonString;
            }
            $("#blist").html('');
            $("#list").html('');

            console.log(cjson.length);
            for (c = 0; c < cjson.length; c++) {

                var j = cjson[c];
                console.log(j);
                processMessage(j);
            }


        }

        function processMessage(jsonString) {
            if (typeof jsonString == "string")
            { var json = JSON.parse(jsonString); }
            else {
                var json = jsonString;
            }
            var str = JSON.stringify(json, null, 2);
            //  alert(str);
            switch (json.Category) {

                case "Release":
                case "Build":
                    var m = json.Message;
                    var t = json.Title;
                    var ctx = json.Context;
                    var cls = "alert-info";
                    var s = json.Status;
                    switch (s) {
                        case "succeeded":
                        case "success":
                            cls = "alert-success";
                            break;

                        case "failed": ;
                        case "rejected":
                            cls = "alert-danger";
                            break;
                    }
                    var inner = "";
                    if (json.Details.length > 0) {
                        var details = "";
                        for (i = 0; i < json.Details.length; i++) {
                            details += "<li>" + json.Details[i] + "</li>";
                        }
                        inner = "<ul>" + details + "</ul>";
                    }
                    if (ctx != "") {
                        $("#blist").children("." + ctx).remove()
                    }
                    $("#blist").append('<div class="' + ctx + 'alert ' + cls + '"><strong>' + t + "</strong><p>" + m + "</p>" + inner + "</div>");
                    while ($("#blist").children().length > 8) {
                        $('#blist div:eq(0)').remove();
                    }
                    break;

                default:
                    var m = json.Message;
                    var t = json.Title;
                    var ctx = json.Context;
                    var cls = "panel-default";
                    var s = json.Status;
                    switch (s) {
                        case "succeeded":
                        case "success":
                            cls = "panel-success";
                            break;

                        case "failed":
                        case "rejected":
                            cls = "panel-danger";
                            break;
                    }
                    var inner = "";
                    if (json.Details.length > 0) {
                        var details = "";
                        for (i = 0; i < json.Details.length; i++) {
                            details += "<li>" + json.Details[i] + "</li>";
                        }
                        inner = "<ul>" + details + "</ul>";
                    }
                    if (ctx != "") {
                        $("#list").children("."+ctx).remove()
                    }
                    $("#list").append('<div class="' + ctx + ' panel ' + cls + '"><div class="panel-body">' + m + inner + "</div></div>");
                    while ($("#list").children().length > 10) {
                        $('#list div:eq(0)').remove();
                    }
                    break;

            }
        };


        /*


        {
  "Title": "string",
  "Message": "Somebody did something strange",
  "Category": "string",
  "Context": "string",
  "SourceData": "string",
  "Timestamp": "2017-07-23T20:40:45.080Z",
  "Details": [
    "A stragne thing #1",
"Another strage thing"
  ],
  "Status": "string"
}

        */
    </script>
}